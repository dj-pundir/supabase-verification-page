<!DOCTYPE html>
<html>
<head>
  <title>Email Verified</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="config.js"></script>
  <style>
    body { font-family: sans-serif; padding: 40px; text-align: center; background: #f9f9f9; }
    h1 { color: #27ae60; }
    .message { margin-top: 20px; font-size: 1.2rem; }
  </style>
</head>
<body>
  <h1>âœ… Verifying your email...</h1>
  <div class="message" id="message">Please wait...</div>

  <script>

    const hash = window.location.hash;
    const urlParams = new URLSearchParams(hash.substring(1)); // remove #
    const accessToken = urlParams.get("access_token");
    const type = urlParams.get("type");

    const supabase = supabase.createClient(
    window.SUPABASE_CONFIG.url,
    window.SUPABASE_CONFIG.anonKey
  );

    async function createUserProfile() {
      if (!accessToken || type !== "signup") {
        document.getElementById("message").textContent = "Invalid or missing token.";
        return;
      }

      // Inject token into Supabase session
      await supabase.auth.setSession({ access_token: accessToken, refresh_token: accessToken });

      const { data: userData, error: userError } = await supabase.auth.getUser();

      if (userError || !userData?.user) {
        document.getElementById("message").textContent = "User not found.";
        return;
      }

      const user = userData.user;

      // Now try to insert a profile
      const { error: insertError } = await supabase.from('users').insert({
        id: user.id,
        email: user.email,
        created_at: new Date().toISOString()
      });

      if (insertError) {
        if (insertError.code === '23505') {
          document.getElementById("message").textContent = "âœ… You're already verified. Welcome back!";
        } else {
          document.getElementById("message").textContent = "Error creating profile: " + insertError.message;
        }
      } else {
        document.getElementById("message").textContent = "ðŸŽ‰ You're verified and your profile has been created!";
      }
    }

    createUserProfile();
  </script>
</body>
</html>
